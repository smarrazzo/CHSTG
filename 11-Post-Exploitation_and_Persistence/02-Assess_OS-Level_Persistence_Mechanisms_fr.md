# Évaluer les mécanismes de persistance au niveau du système d'exploitation

|ID          |
|------------|
|CHSTG-POST-02|

## Résumé

La persistance au niveau du système d'exploitation (OS) garantit qu'un attaquant conserve l'accès au système cible même après un redémarrage ou un cycle d'alimentation. Ce contrôle évalue la faisabilité d'implanter des portes dérobées persistantes au niveau du système d'exploitation en utilisant des techniques qui contournent la surveillance de sécurité standard, telle que la détection et réponse des terminaux (EDR) ou l'antivirus (AV). En exploitant les binaires natifs ou les fichiers de configuration du système alors que le système est hors ligne ou déchiffré, un attaquant peut obtenir un accès permanent avec des privilèges élevés.

## Objectifs du test
- Vérifier si les mécanismes de persistance peuvent être implantés avec succès et survivre à un redémarrage du système.
- Évaluer l'efficacité des techniques « Living off the Land » (LotL) pour éviter la détection par les logiciels de sécurité.
- Obtenir un accès non autorisé et persistant avec les privilèges les plus élevés possibles (SYSTEM ou root).

## Comment tester
Ce test est réalisé sur le système de fichiers cible déchiffré, généralement via un environnement Live USB ou en montant le disque sur une machine secondaire.

### Prérequis
- Un accès complet au système de fichiers cible a été obtenu (voir le nœud **CHSTG-DISK**).
- La capacité d'écrire dans les répertoires système et de modifier les fichiers de configuration.

### Étapes d'exécution
#### Technique Windows : Remplacement des touches rémanentes
1.  **Localiser le binaire :** Naviguer vers le répertoire `C:\Windows\System32\`.
2.  **Implémentation de la porte dérobée :** Remplacer le binaire `sethc.exe` (touches rémanentes) par `ftp.exe`.
    * **Pourquoi `ftp.exe` ?** Bien que `cmd.exe` ou `powershell.exe` soient couramment utilisés, les EDR modernes surveillent fortement leur exécution. `ftp.exe` est souvent négligé mais peut être utilisé pour exécuter des commandes ou accéder à un shell.
3.  **Déclenchement :** Redémarrer le système d'exploitation cible jusqu'à l'écran de connexion. Appuyer rapidement cinq fois sur la touche **Shift**.
4.  **Vérification :** Confirmer que `ftp.exe` s'exécute. Comme `sethc.exe` est une fonctionnalité d'accessibilité au niveau système, il s'exécute avec les privilèges **NT AUTHORITY\SYSTEM** même sans utilisateur authentifié à l'invite de connexion. Vous pouvez obtenir un shell avec la commande `!cmd` ou `!powershell` dans le shell ftp.

#### Technique Linux : Manipulation des identifiants
1.  **Localiser la configuration :** Naviguer vers le répertoire `/etc/`.
2.  **Implémentation de la porte dérobée :** Modifier directement le fichier `/etc/shadow`.
3.  **Modification :** Remplacer le mot de passe hashé de l'utilisateur `root` ou d'un compte utilisateur cible par un hash connu.
4.  **Vérification :** Redémarrer le système d'exploitation cible et tenter de se connecter avec le nouveau mot de passe.

### Critère de succès
- **ÉCHEC :** Un mécanisme de persistance est implanté avec succès, survit à un redémarrage et fournit un accès privilégié non autorisé.

## Remédiation
Si les protections matérielles et disque précédentes ont été contournées, la remédiation à ce stade est difficile.
